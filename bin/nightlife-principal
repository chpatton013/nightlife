#!/usr/bin/env python3

"""
Run the nightlife principal server application.

Server address information is written to the principal lockfile before invoking
the server.

This executable invokes uvicorn to run the webserver as a subprocess.
"""

import argparse
import os
import subprocess
import sys

from nightlife.config import PRINCIPAL_LOCKFILE, write_lockfile


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--host", default="127.0.0.1")
    parser.add_argument("--port", type=int, default=8000)
    args, extra_args = parser.parse_known_args()

    write_lockfile(PRINCIPAL_LOCKFILE, args.host, args.port)

    try:
        p = subprocess.run(
            [
                "uvicorn",
                "nightlife.principal:app",
                f"--host={args.host}",
                f"--port={args.port}",
            ] + extra_args,
            stdin=sys.stdin,
        )
        returncode = p.returncode
    except KeyboardInterrupt:
        returncode = 0
    finally:
        os.unlink(PRINCIPAL_LOCKFILE)

    sys.exit(returncode)
